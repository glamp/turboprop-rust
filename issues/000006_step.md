# Step 6: Cosine Similarity Search Implementation

## Objective
Implement efficient cosine similarity search against the vector index.

## Tasks
1. Implement cosine similarity calculation
2. Create query embedding generation pipeline
3. Add efficient similarity search with ranking
4. Implement result filtering and sorting
5. Add configurable result limits and thresholds
6. Create comprehensive search tests

## Technical Approach
- Cosine similarity: dot(a, b) / (norm(a) * norm(b))
- Pre-normalize vectors during indexing for efficiency
- Linear search initially (HNSW optimization later if needed)
- Return top-k results with similarity scores
- Support similarity threshold filtering

## Dependencies to Add
- `rayon` - Parallel processing for similarity calculations

## Acceptance Criteria
- Generates embeddings for search queries using same model as index
- Calculates cosine similarity efficiently across all indexed vectors
- Returns results sorted by similarity score (descending)
- Supports configurable result limits (default: 10)
- Supports minimum similarity threshold filtering
- Parallel processing for performance on large indices
- Search results include file path, line numbers, similarity score, and content

## CLI Integration
```bash
tp search "jwt authentication" --repo .
tp search "jwt authentication" --repo . --limit 5 --threshold 0.3
```

## Files Created/Modified
- `src/search.rs` - Similarity search implementation
- `src/similarity.rs` - Cosine similarity calculations
- `src/query.rs` - Query processing and embedding
- `tests/search_tests.rs` - Search functionality tests

## Test Cases
- Test search with known query against poker codebase
- Test result ranking and scoring
- Test result limiting and thresholds
- Test search performance with larger datasets
- Test query embedding consistency
- Verify search results are deterministic