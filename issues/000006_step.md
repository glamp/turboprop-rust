# Step 6: Cosine Similarity Search Implementation

## Objective
Implement efficient cosine similarity search against the vector index.

## Tasks
1. Implement cosine similarity calculation
2. Create query embedding generation pipeline
3. Add efficient similarity search with ranking
4. Implement result filtering and sorting
5. Add configurable result limits and thresholds
6. Create comprehensive search tests

## Technical Approach
- Cosine similarity: dot(a, b) / (norm(a) * norm(b))
- Pre-normalize vectors during indexing for efficiency
- Linear search initially (HNSW optimization later if needed)
- Return top-k results with similarity scores
- Support similarity threshold filtering

## Dependencies to Add
- `rayon` - Parallel processing for similarity calculations

## Acceptance Criteria
- Generates embeddings for search queries using same model as index
- Calculates cosine similarity efficiently across all indexed vectors
- Returns results sorted by similarity score (descending)
- Supports configurable result limits (default: 10)
- Supports minimum similarity threshold filtering
- Parallel processing for performance on large indices
- Search results include file path, line numbers, similarity score, and content

## CLI Integration
```bash
tp search "jwt authentication" --repo .
tp search "jwt authentication" --repo . --limit 5 --threshold 0.3
```

## Files Created/Modified
- `src/search.rs` - Similarity search implementation
- `src/similarity.rs` - Cosine similarity calculations
- `src/query.rs` - Query processing and embedding
- `tests/search_tests.rs` - Search functionality tests

## Test Cases
- Test search with known query against poker codebase
- Test result ranking and scoring
- Test result limiting and thresholds
- Test search performance with larger datasets
- Test query embedding consistency
- Verify search results are deterministic

## Proposed Solution

I will implement the cosine similarity search functionality using the following approach:

### Implementation Strategy

1. **Extend CLI Interface**: Add `--limit` and `--threshold` parameters to the search command
2. **Query Processing Module** (`src/query.rs`): Handle query embedding generation using the same embedding model as the index
3. **Search Engine** (`src/search.rs`): Main search orchestration that coordinates query processing, similarity calculation, and result filtering
4. **Similarity Calculations**: Leverage existing cosine similarity in `types.rs`, enhance with parallel processing using `rayon`

### Architecture

The search flow will be:
1. Parse CLI arguments (query, repo path, limit, threshold)
2. Load existing persistent index from the specified repository
3. Generate query embedding using the same model as the index
4. Perform parallel similarity calculation across all indexed chunks
5. Filter results by similarity threshold
6. Sort by similarity score (descending) and apply limit
7. Format and display results with file paths, line numbers, scores, and content previews

### Key Features

- **Parallel Processing**: Use `rayon` for efficient similarity calculations on large indices
- **Configurable Results**: Support for result limits (default: 10) and similarity thresholds
- **Consistent Embeddings**: Ensure query uses same model/configuration as the index
- **Rich Results**: Include file path, line numbers, similarity scores, and content previews
- **Performance Optimized**: Pre-normalized vectors and efficient linear search (HNSW optimization deferred)

### Files to Create/Modify

- `src/query.rs`: Query embedding generation pipeline
- `src/search.rs`: Main search engine implementation  
- `src/cli.rs`: Extended search command with new parameters
- `src/main.rs`: Wire up enhanced search command handling
- `src/lib.rs`: Export new modules and update search_files function
- `tests/search_tests.rs`: Comprehensive test suite
- `Cargo.toml`: Add rayon dependency

This implementation will provide fast, accurate cosine similarity search with flexible configuration options and comprehensive test coverage.