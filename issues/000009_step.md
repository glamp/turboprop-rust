# Step 9: Configuration System and .turboprop.yml Support

## Objective
Implement configuration system to allow customization via `.turboprop.yml` files.

## Tasks
1. Create configuration structure for all CLI options
2. Implement YAML configuration file loading
3. Add configuration precedence (CLI args > config file > defaults)
4. Support repository-specific configuration
5. Add configuration validation and error handling
6. Create configuration documentation and examples

## Technical Approach
- Look for `.turboprop.yml` in repository root
- Support nested configuration options
- Merge configurations with proper precedence
- Validate configuration values at startup
- Provide clear error messages for invalid configs

## Dependencies to Add
- `serde_yaml` - YAML parsing and serialization

## Configuration Structure
```yaml
# .turboprop.yml
embedding:
  model: "sentence-transformers/all-MiniLM-L6-v2"
  batch_size: 32

indexing:
  max_filesize: "2mb"
  chunk_size: 400
  chunk_overlap: 50

search:
  default_limit: 10
  min_similarity: 0.1

directories:
  index_dir: ".turboprop"
  models_dir: ".turboprop/models"
```

## Acceptance Criteria
- Loads configuration from `.turboprop.yml` if present
- CLI arguments override configuration file values
- Configuration file values override built-in defaults
- Validates all configuration values with clear error messages
- Supports all major configuration options (model, limits, directories)
- Configuration changes are reflected in indexing and search behavior
- Invalid configuration files provide helpful error messages

## Files Created/Modified
- `src/config.rs` - Configuration management (extend existing)
- `src/validation.rs` - Configuration validation
- `.turboprop.yml.example` - Example configuration file
- `tests/config_tests.rs` - Configuration loading and validation tests

## Test Cases
- Test configuration loading from file
- Test CLI argument precedence
- Test configuration validation
- Test invalid configuration handling
- Test default value behavior
- Test configuration impact on indexing/search

## Proposed Solution

Based on analysis of the existing codebase, I'll implement YAML configuration support by extending the existing JSON configuration system:

### 1. Configuration Loading Strategy
- Maintain existing `turboprop.json` support for backwards compatibility  
- Add `.turboprop.yml` support as the new preferred format
- Use search order: CLI args > `.turboprop.yml` > `turboprop.json` > defaults
- Repository-specific config takes precedence over global config

### 2. Configuration Structure Mapping
Map the YAML structure to existing Rust structs:
```rust
// YAML maps to existing TurboPropConfig structure:
// embedding -> EmbeddingConfig  
// indexing -> ChunkingConfig + FileDiscoveryConfig
// search -> new SearchConfig structure
// directories -> GeneralConfig paths
```

### 3. Implementation Steps
1. **Extend config.rs**: Add YAML loading alongside existing JSON support
2. **Add SearchConfig**: New struct for search-specific configuration (limits, similarity thresholds)
3. **Create validation.rs**: Centralized configuration validation with detailed error messages
4. **Update precedence logic**: Enhance merge_cli_args to handle YAML precedence
5. **Add file size parsing**: Support "2mb" format in YAML configs using existing `parse_filesize` utility
6. **Comprehensive testing**: TDD approach with tests for loading, validation, precedence, and integration

### 4. Key Features
- **Backwards Compatible**: Existing JSON configs continue working
- **Clear Error Messages**: Detailed validation errors with field-specific guidance
- **Flexible File Size Format**: Support both numeric and human-readable formats ("2mb", "500kb")  
- **Path Validation**: Ensure directory paths are valid and writable
- **Model Validation**: Validate embedding models against available models list
- **Safe Defaults**: All configuration values have sensible defaults

### 5. File Changes
- `src/config.rs`: Add YAML loading, enhance precedence logic
- `src/validation.rs`: New module for configuration validation  
- `.turboprop.yml.example`: Example configuration file
- `tests/config_tests.rs`: Comprehensive test coverage
- Update CLI integration to use new search configuration options