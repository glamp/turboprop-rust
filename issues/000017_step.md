# Step 17: Integrate Glob Filtering with Search Pipeline

## Objective
Connect the glob filtering implementation from Step 16 with the search command execution pipeline to enable end-to-end glob pattern filtering functionality.

## Tasks
1. Update search command to pass glob pattern to SearchFilter
2. Integrate glob filtering with the search result processing pipeline
3. Add logging and debugging output for glob filtering
4. Add integration tests for complete search workflow with glob patterns
5. Verify the specification example works correctly

## Background
This step completes the integration by connecting Steps 14-16's components with the actual search execution, enabling users to filter search results using glob patterns as specified.

## Implementation Details

### 1. Search Command Integration in src/commands/search.rs
Update `execute_search_command()`:
- Pass glob pattern from SearchCommandConfig to SearchFilter::from_cli_args()
- Update SearchFilter::from_cli_args() to accept both filetype and glob parameters
- Ensure proper logging when glob filters are active
- Add debug output showing filter results at each stage

### 2. SearchFilter Updates
Modify `SearchFilter::from_cli_args()` signature:
```rust
pub fn from_cli_args(filetype: Option<String>, glob_pattern: Option<String>) -> Self
```

Update the method to:
- Create FilterConfig with both extension and glob pattern
- Handle cases where both filters are specified
- Maintain backward compatibility for existing filetype-only usage

### 3. Enhanced Logging and Debugging
Add detailed logging:
- Log which glob patterns are active
- Show before/after result counts for each filter stage
- Debug output for pattern matching decisions
- Performance metrics for glob filtering operations

### 4. Error Handling
Robust error handling for:
- Invalid glob patterns that pass CLI validation but fail at runtime
- File system errors during pattern matching
- Empty result sets with informative messages
- Graceful degradation if glob filtering fails

## Integration Tests
Add comprehensive integration tests in `tests/integration/search_tests.rs`:

### 1. Basic Glob Pattern Tests
- Search with `*.rs` pattern
- Search with directory patterns like `src/*.rs`
- Search with recursive patterns like `**/*.js`
- Verify correct files are included/excluded

### 2. Combined Filter Tests  
- Use both `--filetype` and `--filter` simultaneously
- Verify filters work together correctly
- Test precedence and interaction behavior

### 3. Real Codebase Tests
- Test against actual project files
- Verify the specification example: `tp search "jwt authentication" --repo . --filter src/*.js`
- Test edge cases: empty results, no matching files, invalid patterns

### 4. Output Format Tests
- Verify JSON and text output formats work with glob filtering
- Ensure filtered results maintain proper formatting
- Test result limits and thresholds with glob filtering

## Acceptance Criteria
- [ ] SearchFilter::from_cli_args() updated to accept glob pattern
- [ ] Search command properly passes glob pattern through pipeline
- [ ] Complete search workflow works with glob patterns
- [ ] Specification example works: `tp search "jwt authentication" --repo . --filter src/*.js`
- [ ] Both individual and combined filtering work correctly
- [ ] Comprehensive integration test coverage
- [ ] Proper logging and debugging output
- [ ] Error handling for edge cases
- [ ] All output formats work with glob filtering
- [ ] Performance acceptable for typical usage

## Files to Create/Modify
- `src/commands/search.rs` - Update search command to use glob filtering
- `src/filters.rs` - Update SearchFilter::from_cli_args() signature
- `tests/integration/search_tests.rs` - Add glob filtering integration tests

## Success Validation
Run these commands to validate the step:
```bash
# Build and basic tests
cargo build
cargo test

# Integration tests specifically
cargo test integration::search_tests::test_glob_filtering

# End-to-end manual testing
tp search "test" --repo . --filter "*.rs"
tp search "fn main" --repo . --filter "src/*.rs"
tp search "use" --repo . --filter "**/*.rs" --limit 5

# Combined filtering
tp search "test" --repo . --filetype rs --filter "src/*"
```

## Test Scenarios
The integration tests should cover:

1. **Basic Functionality**
   ```bash
   tp search "function" --filter "*.rs"  # Should find .rs files
   tp search "import" --filter "*.js"    # Should find .js files (if any)
   ```

2. **Directory Filtering**
   ```bash
   tp search "test" --filter "src/*.rs"     # Only src directory
   tp search "mod" --filter "tests/*.rs"   # Only tests directory
   ```

3. **Recursive Patterns**
   ```bash
   tp search "struct" --filter "**/mod.rs"  # All mod.rs files
   tp search "impl" --filter "src/**/*.rs"  # All .rs in src tree
   ```

4. **Combined Filters**
   ```bash
   tp search "fn" --filetype rs --filter "src/*"  # Both filters active
   ```

## Notes
After this step, the glob filtering feature will be functionally complete and match the specification requirements. Step 18 will focus on comprehensive testing, edge cases, and documentation.