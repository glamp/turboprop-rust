# Step 7: Index Command Implementation with Progress Tracking

## Objective
Implement the complete `tp index` command with progress indicators and error handling.

## Tasks
1. Wire together file discovery, chunking, embedding, and indexing pipeline
2. Add progress bar showing indexing progress
3. Implement comprehensive error handling and recovery
4. Add index statistics and summary reporting
5. Optimize for batch processing efficiency
6. Create end-to-end tests with poker codebase

## Technical Approach
- Process files in batches for memory efficiency
- Stream processing: discover → read → chunk → embed → index
- Progress tracking with file counts and processing rates
- Graceful handling of individual file processing errors
- Summary statistics: files processed, chunks created, time taken

## Dependencies to Add
- `indicatif` - Progress bars and spinners
- `humantime` - Human-readable time formatting

## Acceptance Criteria
- `tp index --repo .` successfully indexes poker codebase
- Shows progress bar with current file being processed
- Displays final statistics (files processed, chunks, time taken)
- Handles individual file errors gracefully without stopping
- Creates complete index in `.turboprop/` directory
- Processes files in memory-efficient batches
- Supports `--max-filesize` parameter correctly
- Provides clear error messages for common issues

## CLI Integration
```bash
tp index --repo . --max-filesize 2mb
# Output:
# Discovering files... ✓ Found 12 files
# Processing files... [████████████████████████████████████████] 12/12 files
# Generated 156 chunks from 12 files in 2.3s
# Index saved to ./.turboprop/
```

## Files Created/Modified
- `src/commands/index.rs` - Index command implementation
- `src/progress.rs` - Progress reporting utilities
- `src/pipeline.rs` - Processing pipeline coordination
- `tests/integration/index_tests.rs` - End-to-end index tests

## Test Cases
- Test complete indexing pipeline with poker codebase
- Test progress reporting accuracy
- Test error handling for problematic files
- Test index directory creation and structure
- Test batch processing efficiency
- Verify index completeness and correctness

## Proposed Solution

After analyzing the current codebase, I found that most of the core functionality already exists:
- ✅ CLI structure with Index command (`src/cli.rs`)
- ✅ File discovery (`src/files.rs`)
- ✅ Chunking strategy (`src/chunking.rs`) 
- ✅ Embedding generation (`src/embeddings.rs`)
- ✅ Persistent storage (`src/storage.rs`, `src/index.rs`)
- ✅ Complete indexing pipeline (`index_files_with_config` in `src/lib.rs`)

What's missing for Step 7:
- ❌ Progress tracking and user feedback during indexing
- ❌ Graceful error handling for individual file failures
- ❌ Pipeline coordination with proper progress reporting
- ❌ Enhanced index command implementation
- ❌ Integration tests
- ❌ Required dependencies (`indicatif`, `humantime`)

### Implementation Plan:

1. **Add Dependencies** - Add `indicatif` and `humantime` to Cargo.toml
2. **Create Progress Utilities** (`src/progress.rs`)
   - Progress bar management with `indicatif`
   - Time formatting with `humantime`
   - Statistics tracking (files processed, chunks created, time taken)
3. **Create Pipeline Coordinator** (`src/pipeline.rs`) 
   - Coordinate file discovery → chunking → embedding → indexing
   - Integrate progress reporting throughout the pipeline
   - Handle individual file errors gracefully without stopping
   - Provide detailed error reporting
4. **Create Commands Module** (`src/commands/index.rs`)
   - Enhanced index command implementation with progress tracking
   - Replace the current simple `index_files_with_config` call
   - Provide rich user feedback and statistics
5. **Create Integration Tests** (`tests/integration/index_tests.rs`)
   - End-to-end testing with poker codebase
   - Verify progress reporting and error handling
   - Test index completeness and correctness
6. **Update main.rs and lib.rs**
   - Wire the new command structure
   - Ensure proper module exports

### Key Features:
- **Progress Bars**: Show file discovery progress, then processing progress with current file name
- **Error Recovery**: Continue processing other files when individual files fail
- **Statistics**: Display comprehensive summary at completion
- **Memory Efficiency**: Maintain existing batch processing approach
- **User Experience**: Clear, informative output matching the CLI integration example