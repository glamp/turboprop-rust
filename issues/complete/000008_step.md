# Step 8: Search Command Implementation with Output Formatting

## Objective
Implement the complete `tp search` command with JSON and human-readable output formats.

## Tasks
1. Wire together query processing, search, and result formatting
2. Implement line-delimited JSON output format for LLM consumption
3. Add human-readable text output format
4. Support filetype filtering
5. Add result ranking and presentation
6. Create comprehensive search tests

## Technical Approach
- Load existing index from `.turboprop/` directory
- Process search query through embedding pipeline
- Format results according to specified output mode
- Support both streaming and batch result output
- Include file context (surrounding lines) in results

## Acceptance Criteria
- `tp search "query" --repo .` returns relevant results from poker codebase
- Default JSON output is line-delimited for easy LLM parsing
- `--output text` provides human-readable formatted results
- `--filetype .js` correctly filters results by file extension
- Results include file path, line numbers, similarity score, and content
- No results found case handled gracefully
- Results are ranked by relevance (similarity score)
- Fast search performance on indexed data

## CLI Integration
```bash
# JSON output (default)
tp search "jwt authentication" --repo .
{"file":"src/auth.js","line_start":15,"line_end":18,"score":0.87,"content":"..."}

# Human-readable output
tp search "jwt authentication" --repo . --output text
# ðŸ“„ src/auth.js:15-18 (similarity: 87%)
# const token = jwt.sign(payload, secret);
# if (!token) throw new Error('Failed to generate token');

# Filetype filtering
tp search --filetype .ts "interface" --repo .
```

## Files Created/Modified
- `src/commands/search.rs` - Search command implementation
- `src/output.rs` - Result formatting and output
- `src/filters.rs` - Search result filtering
- `tests/integration/search_tests.rs` - End-to-end search tests

## Test Cases
- Test search with known queries against poker codebase
- Test JSON output format for LLM consumption
- Test human-readable text output format
- Test filetype filtering functionality
- Test result ranking and scoring
- Test no results found scenarios
- Verify search performance and accuracy

## Proposed Solution

Based on analysis of the existing codebase, I will implement the search command by:

1. **CLI Enhancement**: Update `src/cli.rs` to add `--output` and `--filetype` parameters to the Search command
2. **Output Formatting**: Create `src/output.rs` module to handle JSON and text output formats
3. **Result Filtering**: Create `src/filters.rs` module to support filetype filtering 
4. **Search Command**: Create `src/commands/search.rs` with complete search command implementation
5. **Integration**: Update `src/main.rs` to use the new search command structure
6. **Testing**: Create comprehensive integration tests

The implementation will leverage existing components:
- `SearchEngine` from `src/search.rs` for core search functionality
- `search_with_config` function for result processing
- `SearchResult` type for standardized result format
- Existing query validation and embedding pipeline

Architecture:
- JSON output will be line-delimited for easy LLM consumption
- Text output will include file context and similarity scores
- Filetype filtering will be applied before search execution  
- Results will be ranked by similarity score (descending)
- Error handling will provide clear user feedback