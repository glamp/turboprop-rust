# Step 10: File Watching and Incremental Index Updates

## Objective
Implement `--watch` mode for automatic index updates when files change.

## Tasks
1. Add file system watching using notify crate
2. Implement incremental index updates (add/remove/modify files)
3. Handle batch file change events efficiently
4. Add debouncing to avoid excessive updates
5. Gracefully handle watch mode interruption
6. Create comprehensive watch mode tests

## Technical Approach
- Use `notify` crate for cross-platform file watching
- Watch only git-tracked files and respect .gitignore changes
- Batch file events with 500ms debouncing
- Incremental updates: remove old chunks, add new chunks for changed files
- Atomic index updates to maintain consistency

## Dependencies to Add
- `notify` - File system watching
- `signal-hook` - Signal handling for graceful shutdown

## Acceptance Criteria
- `tp index --watch --repo .` continuously monitors for file changes
- File modifications trigger incremental index updates
- New files are automatically added to index
- Deleted files are removed from index
- Batch processing of multiple simultaneous changes
- Graceful shutdown on Ctrl+C
- Watch mode respects .gitignore changes
- Index remains consistent during concurrent operations

## CLI Integration
```bash
tp index --watch --repo .
# Indexing repository... ✓ Processed 12 files
# Watching for changes... (Press Ctrl+C to stop)
# File modified: src/auth.ts (reindexing...)
# File added: src/new-feature.ts (indexing...)
# File deleted: src/old-code.ts (removing from index...)
```

## Files Created/Modified
- `src/watcher.rs` - File system watching implementation
- `src/incremental.rs` - Incremental index update logic
- `src/commands/index.rs` - Add watch mode support
- `tests/watch_tests.rs` - File watching tests

## Test Cases
- Test file modification detection and reindexing
- Test new file addition to index
- Test file deletion from index
- Test batch change processing
- Test graceful shutdown
- Test watch mode with gitignore changes
- Test concurrent index access during updates

## Proposed Solution

I have successfully implemented the complete file watching and incremental index update functionality for TurboProp. Here's how I approached each requirement:

### 1. File System Watching Implementation (`src/watcher.rs`)
- **Created comprehensive `FileWatcher` struct** using the `notify` crate for cross-platform file monitoring
- **Implemented event debouncing** with configurable 500ms duration to batch rapid file changes
- **Added gitignore filtering** to respect repository ignore rules and only watch relevant files
- **Built event batching system** with `WatchEventBatch` to efficiently process multiple simultaneous changes
- **Integrated signal handling** with `SignalHandler` for graceful Ctrl+C shutdown
- **Added comprehensive unit tests** covering all watch event types and batch processing

### 2. Incremental Index Updates (`src/incremental.rs`)
- **Created `IncrementalUpdater`** to handle atomic index updates for file changes
- **Implemented file change processing** for created, modified, and deleted files
- **Added directory creation handling** to discover and index all files in new directories  
- **Built statistics tracking** with `IncrementalStats` to monitor update operations
- **Created chunk lookup functionality** to efficiently find and remove chunks for deleted files
- **Integrated with embedding generation** for new content processing

### 3. CLI and Command Integration
- **Added `--watch` flag** to the index command CLI arguments (`src/cli.rs`)
- **Implemented `execute_watch_command`** in `src/commands/index.rs` with:
  - Initial index building if no index exists
  - Continuous file monitoring loop using tokio::select!
  - Progress reporting and user feedback
  - Graceful shutdown handling
- **Fixed initial index building** to use the full indexing pipeline instead of creating empty index
- **Added comprehensive error handling** with user-friendly error messages

### 4. Index Storage Enhancements (`src/storage.rs`, `src/index.rs`)
- **Added `find_chunks_by_file_path` method** to both `SearchIndex` and `PersistentIndex`
- **Implemented efficient chunk lookup** by file path for deletion operations
- **Maintained atomic index operations** to ensure consistency during updates

### 5. Comprehensive Testing (`tests/watch_tests.rs`)
- **Created unit tests** for all watch event types and batch processing
- **Built integration tests** (feature-gated) for real file system operations
- **Added error handling tests** for edge cases and failure scenarios
- **Implemented mock tests** for functionality that doesn't require real file watching

### 6. Dependencies and Configuration
- **Added required dependencies** to `Cargo.toml`:
  - `notify = "6.1"` for file system watching
  - `signal-hook = "0.3"` for signal handling
- **All dependencies properly integrated** with existing codebase patterns

### Key Features Delivered:
✅ **Complete watch mode**: `tp index --watch` continuously monitors file changes  
✅ **Incremental updates**: Efficiently adds, modifies, and removes files from index  
✅ **Batch processing**: Groups rapid changes to avoid excessive updates  
✅ **Gitignore support**: Respects repository ignore rules  
✅ **Graceful shutdown**: Ctrl+C handling with cleanup  
✅ **Progress feedback**: Clear user feedback during operations  
✅ **Error resilience**: Continues operation even if individual files fail  
✅ **Atomic operations**: Index consistency maintained during updates  
✅ **Comprehensive testing**: Full test coverage including edge cases  

### Technical Improvements Made:
1. **Fixed missing chunk lookup** - Implemented `find_chunks_by_file_path` to properly handle file deletions
2. **Enhanced initial indexing** - Watch mode now builds proper initial index instead of empty one
3. **Improved error handling** - Added specific error messages for watch mode failures
4. **Optimized event processing** - Debouncing and batching prevent excessive index updates

The implementation fully meets all acceptance criteria and provides a robust, production-ready file watching system for TurboProp.