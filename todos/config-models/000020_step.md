# Step 20: Extend ModelInfo and ModelManager for Custom Model Types

## Objective
Extend the existing ModelInfo and ModelManager structures to support different model types beyond just fastembed models, laying the foundation for custom model loading.

## Background
Currently, ModelManager in src/models.rs only supports fastembed models. To add the two new models specified (nomic-embed-code.Q5_K_S.gguf and Qwen/Qwen3-Embedding-0.6B), we need to extend the model management system to handle different model sources and types.

## Tasks
1. Add ModelType enum to distinguish between fastembed, GGUF, and Hugging Face models
2. Extend ModelInfo struct with additional metadata for custom models
3. Update ModelManager to handle different model types
4. Add methods for detecting model type from model name
5. Extend get_available_models() to include the new models

## Implementation Details

### 1. Add ModelType Enum
```rust
/// Type of embedding model and how it should be loaded
#[derive(Debug, Clone, PartialEq)]
pub enum ModelType {
    /// Models supported by fastembed library
    FastEmbed,
    /// GGUF quantized models (loaded with candle)
    Gguf,
    /// Hugging Face transformer models
    HuggingFace,
}
```

### 2. Extend ModelInfo Struct
```rust
#[derive(Debug, Clone)]
pub struct ModelInfo {
    /// Model identifier (e.g., "sentence-transformers/all-MiniLM-L6-v2")
    pub name: String,
    /// Human-readable description
    pub description: String,
    /// Embedding dimensions this model produces
    pub dimensions: usize,
    /// Approximate model size in bytes
    pub size_bytes: u64,
    /// Type of model and loading mechanism
    pub model_type: ModelType,
    /// Download URL or Hugging Face model ID
    pub source: String,
    /// Additional metadata for model loading
    pub metadata: ModelMetadata,
}

#[derive(Debug, Clone)]
pub struct ModelMetadata {
    /// For GGUF models: quantization type (e.g., "Q5_K_S")
    pub quantization: Option<String>,
    /// For HF models: model architecture info
    pub architecture: Option<String>,
    /// Context window size
    pub context_length: Option<usize>,
}
```

### 3. Update get_available_models()
Add the two new models to the available models list:
```rust
pub fn get_available_models() -> Vec<ModelInfo> {
    vec![
        // Existing fastembed models
        ModelInfo::new(
            "sentence-transformers/all-MiniLM-L6-v2".to_string(),
            "Fast and lightweight model, good for general use".to_string(),
            384,
            23_000_000,
            ModelType::FastEmbed,
            "sentence-transformers/all-MiniLM-L6-v2".to_string(),
            ModelMetadata::default(),
        ),
        // ... other existing models
        
        // New models from specification
        ModelInfo::new(
            "nomic-embed-code.Q5_K_S.gguf".to_string(),
            "Code embedding model optimized for programming languages".to_string(),
            768, // To be determined in implementation
            180_000_000, // ~180MB estimated
            ModelType::Gguf,
            "https://huggingface.co/lmstudio-community/nomic-embed-code-GGUF/resolve/main/nomic-embed-code.Q5_K_S.gguf".to_string(),
            ModelMetadata {
                quantization: Some("Q5_K_S".to_string()),
                architecture: Some("nomic-embed-code".to_string()),
                context_length: Some(8192),
            },
        ),
        ModelInfo::new(
            "Qwen/Qwen3-Embedding-0.6B".to_string(),
            "Qwen3 embedding model with 1024 dimensions".to_string(),
            1024,
            600_000_000, // ~600MB for 0.6B parameters
            ModelType::HuggingFace,
            "Qwen/Qwen3-Embedding-0.6B".to_string(),
            ModelMetadata {
                quantization: None,
                architecture: Some("qwen3".to_string()),
                context_length: Some(32768),
            },
        ),
    ]
}
```

### 4. Add Model Type Detection
```rust
impl ModelManager {
    /// Determine model type from model name
    pub fn detect_model_type(model_name: &str) -> ModelType {
        if model_name.ends_with(".gguf") {
            ModelType::Gguf
        } else if model_name.contains("/") && !model_name.starts_with("sentence-transformers") {
            ModelType::HuggingFace
        } else {
            ModelType::FastEmbed
        }
    }
    
    /// Get model info by name
    pub fn get_model_info(model_name: &str) -> Option<ModelInfo> {
        Self::get_available_models()
            .into_iter()
            .find(|model| model.name == model_name)
    }
    
    /// Get models by type
    pub fn get_models_by_type(model_type: ModelType) -> Vec<ModelInfo> {
        Self::get_available_models()
            .into_iter()
            .filter(|model| model.model_type == model_type)
            .collect()
    }
}
```

### 5. Update Default Implementations
```rust
impl Default for ModelMetadata {
    fn default() -> Self {
        Self {
            quantization: None,
            architecture: None,
            context_length: None,
        }
    }
}
```

## Test Coverage
Add tests for:
- Model type detection from model names
- Model info retrieval by name
- Filtering models by type
- Default model selection with new models available
- Model metadata handling

## Acceptance Criteria
- [ ] ModelType enum implemented with three variants
- [ ] ModelInfo struct extended with model_type, source, and metadata
- [ ] ModelMetadata struct implemented for additional model info
- [ ] get_available_models() includes both new models with correct metadata
- [ ] detect_model_type() correctly identifies model types from names
- [ ] get_model_info() and get_models_by_type() methods implemented
- [ ] All existing tests continue to pass
- [ ] New tests cover model type detection and filtering
- [ ] `cargo build` and `cargo test` succeed

## Files to Modify
- `src/models.rs` - Extend ModelInfo, ModelManager, add ModelType enum
- `src/models.rs` - Add comprehensive test cases

## Success Validation
```bash
cargo build
cargo test models::test_model_type_detection
cargo test models::test_get_model_info
cargo test models::test_available_models_includes_new_models
```

## Notes
This step only extends the data structures and metadata. No actual model loading is implemented yet. The dimensions for nomic-embed-code model (768) are estimated and will be verified during implementation.

The URL for nomic-embed-code points to lmstudio-community repository based on research, not the original specification URL which appears to be incorrect.